"use strict";var WebMMuxer=(()=>{var Bt=Object.defineProperty;var ui=Object.getOwnPropertyDescriptor;var fi=Object.getOwnPropertyNames,ve=Object.getOwnPropertySymbols;var Re=Object.prototype.hasOwnProperty,ci=Object.prototype.propertyIsEnumerable;var p=Math.pow,Me=(d,e,i)=>e in d?Bt(d,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[e]=i,Fe=(d,e)=>{for(var i in e||={})Re.call(e,i)&&Me(d,i,e[i]);if(ve)for(var i of ve(e))ci.call(e,i)&&Me(d,i,e[i]);return d};var mi=(d,e)=>{for(var i in e)Bt(d,i,{get:e[i],enumerable:!0})},bi=(d,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of fi(e))!Re.call(d,r)&&r!==i&&Bt(d,r,{get:()=>e[r],enumerable:!(s=ui(e,r))||s.enumerable});return d};var pi=d=>bi(Bt({},"__esModule",{value:!0}),d);var ke=(d,e,i)=>{if(!e.has(d))throw TypeError("Cannot "+i)};var t=(d,e,i)=>(ke(d,e,"read from private field"),i?i.call(d):e.get(d)),a=(d,e,i)=>{if(e.has(d))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(d):e.set(d,i)},u=(d,e,i,s)=>(ke(d,e,"write to private field"),s?s.call(d,i):e.set(d,i),i);var h=(d,e,i)=>(ke(d,e,"access private method"),i);var Ai={};mi(Ai,{ArrayBufferTarget:()=>pt,FileSystemWritableFileStreamTarget:()=>gt,Muxer:()=>se,StreamTarget:()=>H,SubtitleEncoder:()=>ge});var I=class{constructor(e){this.value=e}},O=class{constructor(e){this.value=e}};var Ce=d=>d<1<<8?1:d<1<<16?2:d<1<<24?3:d<p(2,32)?4:d<p(2,40)?5:6,_e=d=>{if(d<(1<<7)-1)return 1;if(d<(1<<14)-1)return 2;if(d<(1<<21)-1)return 3;if(d<(1<<28)-1)return 4;if(d<p(2,35)-1)return 5;if(d<p(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+d)};var W=(d,e,i)=>{let s=0;for(let r=e;r<i;r++){let n=Math.floor(r/8),o=d[n],c=7-(r&7),b=(o&1<<c)>>c;s<<=1,s|=b}return s},Ne=(d,e,i,s)=>{for(let r=e;r<i;r++){let n=Math.floor(r/8),o=d[n],c=7-(r&7);o&=~(1<<c),o|=(s&1<<i-r-1)>>i-r-1<<c,d[n]=o}};var pt=class{constructor(){this.buffer=null}},H=class{constructor(e){this.options=e}},gt=class{constructor(e,i){this.stream=e;this.options=i}};var A,m,Yt,Oe,Zt,We,qt,He,kt,Te,Qt,Be,Kt=class{constructor(){a(this,Yt);a(this,Zt);a(this,qt);a(this,kt);a(this,Qt);this.pos=0;a(this,A,new Uint8Array(8));a(this,m,new DataView(t(this,A).buffer));this.offsets=new WeakMap;this.dataOffsets=new WeakMap}seek(e){this.pos=e}writeEBMLVarInt(e,i=_e(e)){let s=0;switch(i){case 1:t(this,m).setUint8(s++,1<<7|e);break;case 2:t(this,m).setUint8(s++,1<<6|e>>8),t(this,m).setUint8(s++,e);break;case 3:t(this,m).setUint8(s++,1<<5|e>>16),t(this,m).setUint8(s++,e>>8),t(this,m).setUint8(s++,e);break;case 4:t(this,m).setUint8(s++,1<<4|e>>24),t(this,m).setUint8(s++,e>>16),t(this,m).setUint8(s++,e>>8),t(this,m).setUint8(s++,e);break;case 5:t(this,m).setUint8(s++,1<<3|e/p(2,32)&7),t(this,m).setUint8(s++,e>>24),t(this,m).setUint8(s++,e>>16),t(this,m).setUint8(s++,e>>8),t(this,m).setUint8(s++,e);break;case 6:t(this,m).setUint8(s++,1<<2|e/p(2,40)&3),t(this,m).setUint8(s++,e/p(2,32)|0),t(this,m).setUint8(s++,e>>24),t(this,m).setUint8(s++,e>>16),t(this,m).setUint8(s++,e>>8),t(this,m).setUint8(s++,e);break;default:throw new Error("Bad EBML VINT size "+i)}this.write(t(this,A).subarray(0,s))}writeEBML(e){var i,s;if(e!==null)if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let r of e)this.writeEBML(r);else if(this.offsets.set(e,this.pos),h(this,kt,Te).call(this,e.id),Array.isArray(e.data)){let r=this.pos,n=e.size===-1?1:(i=e.size)!=null?i:4;e.size===-1?h(this,Yt,Oe).call(this,255):this.seek(this.pos+n);let o=this.pos;if(this.dataOffsets.set(e,o),this.writeEBML(e.data),e.size!==-1){let c=this.pos-o,b=this.pos;this.seek(r),this.writeEBMLVarInt(c,n),this.seek(b)}}else if(typeof e.data=="number"){let r=(s=e.size)!=null?s:Ce(e.data);this.writeEBMLVarInt(r),h(this,kt,Te).call(this,e.data,r)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),h(this,Qt,Be).call(this,e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof I?(this.writeEBMLVarInt(4),h(this,Zt,We).call(this,e.data.value)):e.data instanceof O&&(this.writeEBMLVarInt(8),h(this,qt,He).call(this,e.data.value))}};A=new WeakMap,m=new WeakMap,Yt=new WeakSet,Oe=function(e){t(this,m).setUint8(0,e),this.write(t(this,A).subarray(0,1))},Zt=new WeakSet,We=function(e){t(this,m).setFloat32(0,e,!1),this.write(t(this,A).subarray(0,4))},qt=new WeakSet,He=function(e){t(this,m).setFloat64(0,e,!1),this.write(t(this,A))},kt=new WeakSet,Te=function(e,i=Ce(e)){let s=0;switch(i){case 6:t(this,m).setUint8(s++,e/p(2,40)|0);case 5:t(this,m).setUint8(s++,e/p(2,32)|0);case 4:t(this,m).setUint8(s++,e>>24);case 3:t(this,m).setUint8(s++,e>>16);case 2:t(this,m).setUint8(s++,e>>8);case 1:t(this,m).setUint8(s++,e);break;default:throw new Error("Bad UINT size "+i)}this.write(t(this,A).subarray(0,s))},Qt=new WeakSet,Be=function(e){this.write(new Uint8Array(e.split("").map(i=>i.charCodeAt(0))))};var Ct,P,tt,Tt,xe,Gt=class extends Kt{constructor(i){super();a(this,Tt);a(this,Ct,void 0);a(this,P,new ArrayBuffer(p(2,16)));a(this,tt,new Uint8Array(t(this,P)));u(this,Ct,i)}write(i){h(this,Tt,xe).call(this,this.pos+i.byteLength),t(this,tt).set(i,this.pos),this.pos+=i.byteLength}finalize(){h(this,Tt,xe).call(this,this.pos),t(this,Ct).buffer=t(this,P).slice(0,this.pos)}};Ct=new WeakMap,P=new WeakMap,tt=new WeakMap,Tt=new WeakSet,xe=function(i){let s=t(this,P).byteLength;for(;s<i;)s*=2;if(s===t(this,P).byteLength)return;let r=new ArrayBuffer(s),n=new Uint8Array(r);n.set(t(this,tt),0),u(this,P,r),u(this,tt,n)};var B,k,C,v,U=class extends Kt{constructor(i){super();this.target=i;a(this,B,!1);a(this,k,void 0);a(this,C,void 0);a(this,v,void 0)}write(i){if(!t(this,B))return;let s=this.pos;if(s<t(this,C)){if(s+i.byteLength<=t(this,C))return;i=i.subarray(t(this,C)-s),s=0}let r=s+i.byteLength-t(this,C),n=t(this,k).byteLength;for(;n<r;)n*=2;if(n!==t(this,k).byteLength){let o=new Uint8Array(n);o.set(t(this,k),0),u(this,k,o)}t(this,k).set(i,s-t(this,C)),u(this,v,Math.max(t(this,v),s+i.byteLength))}startTrackingWrites(){u(this,B,!0),u(this,k,new Uint8Array(p(2,10))),u(this,C,this.pos),u(this,v,this.pos)}getTrackedWrites(){if(!t(this,B))throw new Error("Can't get tracked writes since nothing was tracked.");let s={data:t(this,k).subarray(0,t(this,v)-t(this,C)),start:t(this,C),end:t(this,v)};return u(this,k,void 0),u(this,B,!1),s}};B=new WeakMap,k=new WeakMap,C=new WeakMap,v=new WeakMap;var M,xt,St,wt=class extends U{constructor(i,s){super(i);a(this,M,[]);a(this,xt,0);a(this,St,void 0);u(this,St,s)}write(i){super.write(i),t(this,M).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}flush(){var r,n;if(t(this,M).length===0)return;let i=[],s=[...t(this,M)].sort((o,c)=>o.start-c.start);i.push({start:s[0].start,size:s[0].data.byteLength});for(let o=1;o<s.length;o++){let c=i[i.length-1],b=s[o];b.start<=c.start+c.size?c.size=Math.max(c.size,b.start+b.data.byteLength-c.start):i.push({start:b.start,size:b.data.byteLength})}for(let o of i){o.data=new Uint8Array(o.size);for(let c of t(this,M))o.start<=c.start&&c.start<o.start+o.size&&o.data.set(c.data,c.start-o.start);if(t(this,St)&&o.start<t(this,xt))throw new Error("Internal error: Monotonicity violation.");(n=(r=this.target.options).onData)==null||n.call(r,o.data,o.start),u(this,xt,o.start+o.data.byteLength)}t(this,M).length=0}finalize(){}};M=new WeakMap,xt=new WeakMap,St=new WeakMap;var gi=p(2,24),wi=2,y,w,At,Ut,Et,Se,Xt,$e,jt,Ke,et,$t,yt=class extends U{constructor(i,s){var r,n;super(i);a(this,Et);a(this,Xt);a(this,jt);a(this,et);a(this,y,void 0);a(this,w,[]);a(this,At,0);a(this,Ut,void 0);if(u(this,y,(n=(r=i.options)==null?void 0:r.chunkSize)!=null?n:gi),u(this,Ut,s),!Number.isInteger(t(this,y))||t(this,y)<p(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(i){super.write(i),h(this,Et,Se).call(this,i,this.pos),h(this,et,$t).call(this),this.pos+=i.byteLength}finalize(){h(this,et,$t).call(this,!0)}};y=new WeakMap,w=new WeakMap,At=new WeakMap,Ut=new WeakMap,Et=new WeakSet,Se=function(i,s){let r=t(this,w).findIndex(g=>g.start<=s&&s<g.start+t(this,y));r===-1&&(r=h(this,jt,Ke).call(this,s));let n=t(this,w)[r],o=s-n.start,c=i.subarray(0,Math.min(t(this,y)-o,i.byteLength));n.data.set(c,o);let b={start:o,end:o+c.byteLength};if(h(this,Xt,$e).call(this,n,b),n.written[0].start===0&&n.written[0].end===t(this,y)&&(n.shouldFlush=!0),t(this,w).length>wi){for(let g=0;g<t(this,w).length-1;g++)t(this,w)[g].shouldFlush=!0;h(this,et,$t).call(this)}c.byteLength<i.byteLength&&h(this,Et,Se).call(this,i.subarray(c.byteLength),s+c.byteLength)},Xt=new WeakSet,$e=function(i,s){let r=0,n=i.written.length-1,o=-1;for(;r<=n;){let c=Math.floor(r+(n-r+1)/2);i.written[c].start<=s.start?(r=c+1,o=c):n=c-1}for(i.written.splice(o+1,0,s),(o===-1||i.written[o].end<s.start)&&o++;o<i.written.length-1&&i.written[o].end>=i.written[o+1].start;)i.written[o].end=Math.max(i.written[o].end,i.written[o+1].end),i.written.splice(o+1,1)},jt=new WeakSet,Ke=function(i){let r={start:Math.floor(i/t(this,y))*t(this,y),data:new Uint8Array(t(this,y)),written:[],shouldFlush:!1};return t(this,w).push(r),t(this,w).sort((n,o)=>n.start-o.start),t(this,w).indexOf(r)},et=new WeakSet,$t=function(i=!1){var s,r;for(let n=0;n<t(this,w).length;n++){let o=t(this,w)[n];if(!(!o.shouldFlush&&!i)){for(let c of o.written){if(t(this,Ut)&&o.start+c.start<t(this,At))throw new Error("Internal error: Monotonicity violation.");(r=(s=this.target.options).onData)==null||r.call(s,o.data.subarray(c.start,c.end),o.start+c.start),u(this,At,o.start+c.end)}t(this,w).splice(n--,1)}}};var Lt=class extends yt{constructor(e,i){var s;super(new H({onData:(r,n)=>e.stream.write({type:"write",data:r,position:n}),chunked:!0,chunkSize:(s=e.options)==null?void 0:s.chunkSize}),i)}};var it=1,zt=2,Jt=3,yi=1,ki=2,Ci=17,Ae=p(2,15),Vt=p(2,12),Ge="https://github.com/Vanilagy/webm-muxer",Le=6,Ye=5,Ti=["strict","offset","permissive"],f,l,at,nt,x,$,K,R,G,z,L,Y,S,Z,q,V,D,F,ot,ht,Q,X,Pt,dt,vt,re,Ze,ae,qe,ne,Qe,oe,Xe,he,je,de,Je,le,Ie,Mt,Ue,Rt,Ee,ue,ti,_,st,N,rt,fe,ei,ce,ii,lt,It,ut,te,me,si,T,E,j,Dt,ft,ee,be,ri,Ft,ze,ct,ie,se=class{constructor(e){a(this,re);a(this,ae);a(this,ne);a(this,oe);a(this,he);a(this,de);a(this,le);a(this,Mt);a(this,Rt);a(this,ue);a(this,_);a(this,N);a(this,fe);a(this,ce);a(this,lt);a(this,ut);a(this,me);a(this,T);a(this,j);a(this,ft);a(this,be);a(this,Ft);a(this,ct);a(this,f,void 0);a(this,l,void 0);a(this,at,void 0);a(this,nt,void 0);a(this,x,void 0);a(this,$,void 0);a(this,K,void 0);a(this,R,void 0);a(this,G,void 0);a(this,z,void 0);a(this,L,void 0);a(this,Y,void 0);a(this,S,void 0);a(this,Z,void 0);a(this,q,0);a(this,V,[]);a(this,D,[]);a(this,F,[]);a(this,ot,void 0);a(this,ht,void 0);a(this,Q,-1);a(this,X,-1);a(this,Pt,-1);a(this,dt,void 0);a(this,vt,!1);var s;h(this,re,Ze).call(this,e),u(this,f,Fe({type:"webm",firstTimestampBehavior:"strict"},e)),this.target=e.target;let i=!!t(this,f).streaming;if(e.target instanceof pt)u(this,l,new Gt(e.target));else if(e.target instanceof H)u(this,l,(s=e.target.options)!=null&&s.chunked?new yt(e.target,i):new wt(e.target,i));else if(e.target instanceof gt)u(this,l,new Lt(e.target,i));else throw new Error(`Invalid target: ${e.target}`);h(this,ae,qe).call(this)}addVideoChunk(e,i,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addVideoChunkRaw(r,e.type,s!=null?s:e.timestamp,i)}addVideoChunkRaw(e,i,s,r){if(h(this,ct,ie).call(this),!t(this,f).video)throw new Error("No video track declared.");t(this,ot)===void 0&&u(this,ot,s),r&&h(this,fe,ei).call(this,r);let n=h(this,ut,te).call(this,e,i,s,it);for(t(this,f).video.codec==="V_VP9"&&h(this,ce,ii).call(this,n),u(this,Q,n.timestamp);t(this,D).length>0&&t(this,D)[0].timestamp<=n.timestamp;){let o=t(this,D).shift();h(this,T,E).call(this,o,!1)}!t(this,f).audio||n.timestamp<=t(this,X)?h(this,T,E).call(this,n,!0):t(this,V).push(n),h(this,lt,It).call(this),h(this,_,st).call(this)}addAudioChunk(e,i,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addAudioChunkRaw(r,e.type,s!=null?s:e.timestamp,i)}addAudioChunkRaw(e,i,s,r){if(h(this,ct,ie).call(this),!t(this,f).audio)throw new Error("No audio track declared.");t(this,ht)===void 0&&u(this,ht,s),r!=null&&r.decoderConfig&&(t(this,f).streaming?u(this,z,h(this,j,Dt).call(this,r.decoderConfig.description)):h(this,ft,ee).call(this,t(this,z),r.decoderConfig.description));let n=h(this,ut,te).call(this,e,i,s,zt);for(u(this,X,n.timestamp);t(this,V).length>0&&t(this,V)[0].timestamp<=n.timestamp;){let o=t(this,V).shift();h(this,T,E).call(this,o,!0)}!t(this,f).video||n.timestamp<=t(this,Q)?h(this,T,E).call(this,n,!t(this,f).video):t(this,D).push(n),h(this,lt,It).call(this),h(this,_,st).call(this)}addSubtitleChunk(e,i,s){if(h(this,ct,ie).call(this),!t(this,f).subtitles)throw new Error("No subtitle track declared.");i!=null&&i.decoderConfig&&(t(this,f).streaming?u(this,L,h(this,j,Dt).call(this,i.decoderConfig.description)):h(this,ft,ee).call(this,t(this,L),i.decoderConfig.description));let r=h(this,ut,te).call(this,e.body,"key",s!=null?s:e.timestamp,Jt,e.duration,e.additions);u(this,Pt,r.timestamp),t(this,F).push(r),h(this,lt,It).call(this),h(this,_,st).call(this)}finalize(){for(;t(this,V).length>0;)h(this,T,E).call(this,t(this,V).shift(),!0);for(;t(this,D).length>0;)h(this,T,E).call(this,t(this,D).shift(),!0);for(;t(this,F).length>0&&t(this,F)[0].timestamp<=t(this,q);)h(this,T,E).call(this,t(this,F).shift(),!1);if(t(this,f).streaming||h(this,Ft,ze).call(this),t(this,l).writeEBML(t(this,Y)),!t(this,f).streaming){let e=t(this,l).pos,i=t(this,l).pos-t(this,N,rt);t(this,l).seek(t(this,l).offsets.get(t(this,at))+4),t(this,l).writeEBMLVarInt(i,Le),t(this,K).data=new O(t(this,q)),t(this,l).seek(t(this,l).offsets.get(t(this,K))),t(this,l).writeEBML(t(this,K)),t(this,x).data[0].data[1].data=t(this,l).offsets.get(t(this,Y))-t(this,N,rt),t(this,x).data[1].data[1].data=t(this,l).offsets.get(t(this,nt))-t(this,N,rt),t(this,x).data[2].data[1].data=t(this,l).offsets.get(t(this,$))-t(this,N,rt),t(this,l).seek(t(this,l).offsets.get(t(this,x))),t(this,l).writeEBML(t(this,x)),t(this,l).seek(e)}h(this,_,st).call(this),t(this,l).finalize(),u(this,vt,!0)}};f=new WeakMap,l=new WeakMap,at=new WeakMap,nt=new WeakMap,x=new WeakMap,$=new WeakMap,K=new WeakMap,R=new WeakMap,G=new WeakMap,z=new WeakMap,L=new WeakMap,Y=new WeakMap,S=new WeakMap,Z=new WeakMap,q=new WeakMap,V=new WeakMap,D=new WeakMap,F=new WeakMap,ot=new WeakMap,ht=new WeakMap,Q=new WeakMap,X=new WeakMap,Pt=new WeakMap,dt=new WeakMap,vt=new WeakMap,re=new WeakSet,Ze=function(e){if(e.type&&e.type!=="webm"&&e.type!=="matroska")throw new Error(`Invalid type: ${e.type}`);if(e.firstTimestampBehavior&&!Ti.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},ae=new WeakSet,qe=function(){t(this,l)instanceof U&&t(this,l).target.options.onHeader&&t(this,l).startTrackingWrites(),h(this,ne,Qe).call(this),t(this,f).streaming||h(this,de,Je).call(this),h(this,le,Ie).call(this),h(this,oe,Xe).call(this),h(this,he,je).call(this),t(this,f).streaming||(h(this,Mt,Ue).call(this),h(this,Rt,Ee).call(this)),h(this,ue,ti).call(this),h(this,_,st).call(this)},ne=new WeakSet,Qe=function(){var i;let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:(i=t(this,f).type)!=null?i:"webm"},{id:17031,data:2},{id:17029,data:2}]};t(this,l).writeEBML(e)},oe=new WeakSet,Xe=function(){u(this,G,{id:236,size:4,data:new Uint8Array(Vt)}),u(this,z,{id:236,size:4,data:new Uint8Array(Vt)}),u(this,L,{id:236,size:4,data:new Uint8Array(Vt)})},he=new WeakSet,je=function(){u(this,R,{id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]})},de=new WeakSet,Je=function(){let e=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]};u(this,x,r)},le=new WeakSet,Ie=function(){let e={id:17545,data:new O(0)};u(this,K,e);let i={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Ge},{id:22337,data:Ge},t(this,f).streaming?null:e]};u(this,nt,i)},Mt=new WeakSet,Ue=function(){let e={id:374648427,data:[]};u(this,$,e),t(this,f).video&&e.data.push({id:174,data:[{id:215,data:it},{id:29637,data:it},{id:131,data:yi},{id:134,data:t(this,f).video.codec},t(this,G),t(this,f).video.frameRate?{id:2352003,data:1e9/t(this,f).video.frameRate}:null,{id:224,data:[{id:176,data:t(this,f).video.width},{id:186,data:t(this,f).video.height},t(this,f).video.alpha?{id:21440,data:1}:null,t(this,R)]}]}),t(this,f).audio&&(u(this,z,t(this,f).streaming?t(this,z)||null:{id:236,size:4,data:new Uint8Array(Vt)}),e.data.push({id:174,data:[{id:215,data:zt},{id:29637,data:zt},{id:131,data:ki},{id:134,data:t(this,f).audio.codec},t(this,z),{id:225,data:[{id:181,data:new I(t(this,f).audio.sampleRate)},{id:159,data:t(this,f).audio.numberOfChannels},t(this,f).audio.bitDepth?{id:25188,data:t(this,f).audio.bitDepth}:null]}]})),t(this,f).subtitles&&e.data.push({id:174,data:[{id:215,data:Jt},{id:29637,data:Jt},{id:131,data:Ci},{id:134,data:t(this,f).subtitles.codec},t(this,L)]})},Rt=new WeakSet,Ee=function(){let e={id:408125543,size:t(this,f).streaming?-1:Le,data:[t(this,f).streaming?null:t(this,x),t(this,nt),t(this,$)]};if(u(this,at,e),t(this,l).writeEBML(e),t(this,l)instanceof U&&t(this,l).target.options.onHeader){let{data:i,start:s}=t(this,l).getTrackedWrites();t(this,l).target.options.onHeader(i,s)}},ue=new WeakSet,ti=function(){u(this,Y,{id:475249515,data:[]})},_=new WeakSet,st=function(){t(this,l)instanceof wt&&t(this,l).flush()},N=new WeakSet,rt=function(){return t(this,l).dataOffsets.get(t(this,at))},fe=new WeakSet,ei=function(e){if(!!e.decoderConfig){if(e.decoderConfig.colorSpace){let i=e.decoderConfig.colorSpace;if(u(this,dt,i),t(this,R).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[i.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[i.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[i.primaries]},{id:21945,data:[1,2][Number(i.fullRange)]}],!t(this,f).streaming){let s=t(this,l).pos;t(this,l).seek(t(this,l).offsets.get(t(this,R))),t(this,l).writeEBML(t(this,R)),t(this,l).seek(s)}}e.decoderConfig.description&&(t(this,f).streaming?u(this,G,h(this,j,Dt).call(this,e.decoderConfig.description)):h(this,ft,ee).call(this,t(this,G),e.decoderConfig.description))}},ce=new WeakSet,ii=function(e){if(e.type!=="key"||!t(this,dt))return;let i=0;if(W(e.data,0,2)!==2)return;i+=2;let s=(W(e.data,i+1,i+2)<<1)+W(e.data,i+0,i+1);i+=2,s===3&&i++;let r=W(e.data,i+0,i+1);if(i++,r)return;let n=W(e.data,i+0,i+1);if(i++,n!==0)return;i+=2;let o=W(e.data,i+0,i+24);if(i+=24,o!==4817730)return;s>=2&&i++;let c={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[t(this,dt).matrix];Ne(e.data,i+0,i+3,c)},lt=new WeakSet,It=function(){let e=Math.min(t(this,f).video?t(this,Q):1/0,t(this,f).audio?t(this,X):1/0),i=t(this,F);for(;i.length>0&&i[0].timestamp<=e;)h(this,T,E).call(this,i.shift(),!t(this,f).video&&!t(this,f).audio)},ut=new WeakSet,te=function(e,i,s,r,n,o){let c=h(this,me,si).call(this,s,r);return{data:e,additions:o,type:i,timestamp:c,duration:n,trackNumber:r}},me=new WeakSet,si=function(e,i){let s=i===it?t(this,Q):i===zt?t(this,X):t(this,Pt);if(i!==Jt){let r=i===it?t(this,ot):t(this,ht);if(t(this,f).firstTimestampBehavior==="strict"&&s===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);t(this,f).firstTimestampBehavior==="offset"&&(e-=r)}if(e<s)throw new Error(`Timestamps must be monotonically increasing (went from ${s} to ${e}).`);if(e<0)throw new Error(`Timestamps must be non-negative (received ${e}).`);return e},T=new WeakSet,E=function(e,i){t(this,f).streaming&&!t(this,$)&&(h(this,Mt,Ue).call(this),h(this,Rt,Ee).call(this));let s=Math.floor(e.timestamp/1e3),r=i&&e.type==="key"&&s-t(this,Z)>=1e3;(!t(this,S)||r)&&h(this,be,ri).call(this,s);let n=s-t(this,Z);if(n<0)return;if(n>=Ae)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${Ae} milliseconds. In order to produce a correct WebM file, you must pass in a key frame at least every ${Ae} milliseconds.`);let c=new Uint8Array(4),b=new DataView(c.buffer);if(b.setUint8(0,128|e.trackNumber),b.setInt16(1,n,!1),e.duration===void 0&&!e.additions){b.setUint8(3,Number(e.type==="key")<<7);let g={id:163,data:[c,e.data]};t(this,l).writeEBML(g)}else{let g=Math.floor(e.duration/1e3),bt={id:160,data:[{id:161,data:[c,e.data]},e.duration!==void 0?{id:155,data:g}:null,e.additions?{id:30113,data:e.additions}:null]};t(this,l).writeEBML(bt)}u(this,q,Math.max(t(this,q),s))},j=new WeakSet,Dt=function(e){return{id:25506,size:4,data:new Uint8Array(e)}},ft=new WeakSet,ee=function(e,i){let s=t(this,l).pos;t(this,l).seek(t(this,l).offsets.get(e));let r=2+4+i.byteLength,n=Vt-r;if(n<0){let o=i.byteLength+n;i instanceof ArrayBuffer?i=i.slice(0,o):i=i.buffer.slice(0,o),n=0}e=[h(this,j,Dt).call(this,i),{id:236,size:4,data:new Uint8Array(n)}],t(this,l).writeEBML(e),t(this,l).seek(s)},be=new WeakSet,ri=function(e){t(this,S)&&!t(this,f).streaming&&h(this,Ft,ze).call(this),t(this,l)instanceof U&&t(this,l).target.options.onCluster&&t(this,l).startTrackingWrites(),u(this,S,{id:524531317,size:t(this,f).streaming?-1:Ye,data:[{id:231,data:e}]}),t(this,l).writeEBML(t(this,S)),u(this,Z,e);let i=t(this,l).offsets.get(t(this,S))-t(this,N,rt);t(this,Y).data.push({id:187,data:[{id:179,data:e},t(this,f).video?{id:183,data:[{id:247,data:it},{id:241,data:i}]}:null,t(this,f).audio?{id:183,data:[{id:247,data:zt},{id:241,data:i}]}:null]})},Ft=new WeakSet,ze=function(){let e=t(this,l).pos-t(this,l).dataOffsets.get(t(this,S)),i=t(this,l).pos;if(t(this,l).seek(t(this,l).offsets.get(t(this,S))+4),t(this,l).writeEBMLVarInt(e,Ye),t(this,l).seek(i),t(this,l)instanceof U&&t(this,l).target.options.onCluster){let{data:s,start:r}=t(this,l).getTrackedWrites();t(this,l).target.options.onCluster(s,r,t(this,Z))}},ct=new WeakSet,ie=function(){if(t(this,vt))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var _t=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,xi=/^WEBVTT.*?\n{2}/,Si=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,ai=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Ve=new TextEncoder,J,Nt,Ot,Wt,Ht,mt,pe,we,ni,ge=class{constructor(e){a(this,mt);a(this,we);a(this,J,void 0);a(this,Nt,void 0);a(this,Ot,!1);a(this,Wt,void 0);a(this,Ht,!1);u(this,J,e)}configure(e){if(e.codec!=="webvtt")throw new Error("Codec must be 'webvtt'.");u(this,Nt,e)}encode(e){var s;if(!t(this,Nt))throw new Error("Encoder not configured.");e=e.replace(`\r
`,`
`).replace("\r",`
`),_t.lastIndex=0;let i;if(!t(this,Ot)){if(!xi.test(e)){let n=new Error("WebVTT preamble incorrect.");throw t(this,J).error(n),n}i=_t.exec(e);let r=e.slice(0,(s=i==null?void 0:i.index)!=null?s:e.length).trimEnd();if(!r){let n=new Error("No WebVTT preamble provided.");throw t(this,J).error(n),n}u(this,Wt,Ve.encode(r)),u(this,Ot,!0),i&&(e=e.slice(i.index),_t.lastIndex=0)}for(;i=_t.exec(e);){let r=e.slice(0,i.index),n=i[1]||"",o=i.index+i[0].length,c=e.indexOf(`
`,o)+1,b=e.slice(o,c).trim(),g=e.indexOf(`

`,o);g===-1&&(g=e.length);let bt=h(this,mt,pe).call(this,i[2]),oi=h(this,mt,pe).call(this,i[3])-bt,ye=e.slice(c,g),De=`${b}
${n}
${r}`;ai.lastIndex=0,ye=ye.replace(ai,di=>{let li=h(this,mt,pe).call(this,di.slice(1,-1))-bt;return`<${h(this,we,ni).call(this,li)}>`}),e=e.slice(g).trimStart(),_t.lastIndex=0;let hi={body:Ve.encode(ye),additions:De.trim()===""?void 0:Ve.encode(De),timestamp:bt*1e3,duration:oi*1e3},Pe={};t(this,Ht)||(Pe.decoderConfig={description:t(this,Wt)},u(this,Ht,!0)),t(this,J).output(hi,Pe)}}};J=new WeakMap,Nt=new WeakMap,Ot=new WeakMap,Wt=new WeakMap,Ht=new WeakMap,mt=new WeakSet,pe=function(e){let i=Si.exec(e);if(!i)throw new Error("Expected match.");return 60*60*1e3*Number(i[1]||"0")+60*1e3*Number(i[2])+1e3*Number(i[3])+Number(i[4])},we=new WeakSet,ni=function(e){let i=Math.floor(e/36e5),s=Math.floor(e%(60*60*1e3)/(60*1e3)),r=Math.floor(e%(60*1e3)/1e3),n=e%1e3;return i.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+n.toString().padStart(3,"0")};return pi(Ai);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, WebMMuxer)
