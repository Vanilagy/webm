"use strict";var WebMMuxer=(()=>{var Wt=Object.defineProperty;var di=Object.getOwnPropertyDescriptor;var li=Object.getOwnPropertyNames,Ve=Object.getOwnPropertySymbols;var Ne=Object.prototype.hasOwnProperty,ui=Object.prototype.propertyIsEnumerable;var p=Math.pow,Pe=(d,t,i)=>t in d?Wt(d,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[t]=i,ve=(d,t)=>{for(var i in t||={})Ne.call(t,i)&&Pe(d,i,t[i]);if(Ve)for(var i of Ve(t))ui.call(t,i)&&Pe(d,i,t[i]);return d};var ci=(d,t)=>{for(var i in t)Wt(d,i,{get:t[i],enumerable:!0})},fi=(d,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of li(t))!Ne.call(d,s)&&s!==i&&Wt(d,s,{get:()=>t[s],enumerable:!(r=di(t,s))||r.enumerable});return d};var mi=d=>fi(Wt({},"__esModule",{value:!0}),d);var be=(d,t,i)=>{if(!t.has(d))throw TypeError("Cannot "+i)};var e=(d,t,i)=>(be(d,t,"read from private field"),i?i.call(d):t.get(d)),o=(d,t,i)=>{if(t.has(d))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(d):t.set(d,i)},c=(d,t,i,r)=>(be(d,t,"write to private field"),r?r.call(d,i):t.set(d,i),i);var h=(d,t,i)=>(be(d,t,"access private method"),i);var Ci={};ci(Ci,{ArrayBufferTarget:()=>ct,FileSystemWritableFileStreamTarget:()=>ft,Muxer:()=>Jt,StreamTarget:()=>O,SubtitleEncoder:()=>ce});var J=class{constructor(t){this.value=t}},_=class{constructor(t){this.value=t}};var pe=d=>d<1<<8?1:d<1<<16?2:d<1<<24?3:d<p(2,32)?4:d<p(2,40)?5:6,Fe=d=>{if(d<(1<<7)-1)return 1;if(d<(1<<14)-1)return 2;if(d<(1<<21)-1)return 3;if(d<(1<<28)-1)return 4;if(d<p(2,35)-1)return 5;if(d<p(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+d)};var W=(d,t,i)=>{let r=0;for(let s=t;s<i;s++){let a=Math.floor(s/8),n=d[a],u=7-(s&7),b=(n&1<<u)>>u;r<<=1,r|=b}return r},Me=(d,t,i,r)=>{for(let s=t;s<i;s++){let a=Math.floor(s/8),n=d[a],u=7-(s&7);n&=~(1<<u),n|=(r&1<<i-s-1)>>i-s-1<<u,d[a]=n}};var ct=class{constructor(){this.buffer=null}},O=class{constructor(t){this.options=t}},ft=class{constructor(t,i){this.stream=t;this.options=i}};var z,m,Kt,Re,qt,_e,Gt,We,pt,ge,Yt,Oe,Ht=class{constructor(){o(this,Kt);o(this,qt);o(this,Gt);o(this,pt);o(this,Yt);this.pos=0;o(this,z,new Uint8Array(8));o(this,m,new DataView(e(this,z).buffer));this.offsets=new WeakMap;this.dataOffsets=new WeakMap}seek(t){this.pos=t}writeEBMLVarInt(t,i=Fe(t)){let r=0;switch(i){case 1:e(this,m).setUint8(r++,1<<7|t);break;case 2:e(this,m).setUint8(r++,1<<6|t>>8),e(this,m).setUint8(r++,t);break;case 3:e(this,m).setUint8(r++,1<<5|t>>16),e(this,m).setUint8(r++,t>>8),e(this,m).setUint8(r++,t);break;case 4:e(this,m).setUint8(r++,1<<4|t>>24),e(this,m).setUint8(r++,t>>16),e(this,m).setUint8(r++,t>>8),e(this,m).setUint8(r++,t);break;case 5:e(this,m).setUint8(r++,1<<3|t/p(2,32)&7),e(this,m).setUint8(r++,t>>24),e(this,m).setUint8(r++,t>>16),e(this,m).setUint8(r++,t>>8),e(this,m).setUint8(r++,t);break;case 6:e(this,m).setUint8(r++,1<<2|t/p(2,40)&3),e(this,m).setUint8(r++,t/p(2,32)|0),e(this,m).setUint8(r++,t>>24),e(this,m).setUint8(r++,t>>16),e(this,m).setUint8(r++,t>>8),e(this,m).setUint8(r++,t);break;default:throw new Error("Bad EBML VINT size "+i)}this.write(e(this,z).subarray(0,r))}writeEBML(t){var i,r;if(t!==null)if(t instanceof Uint8Array)this.write(t);else if(Array.isArray(t))for(let s of t)this.writeEBML(s);else if(this.offsets.set(t,this.pos),h(this,pt,ge).call(this,t.id),Array.isArray(t.data)){let s=this.pos,a=t.size===-1?1:(i=t.size)!=null?i:4;t.size===-1?h(this,Kt,Re).call(this,255):this.seek(this.pos+a);let n=this.pos;if(this.dataOffsets.set(t,n),this.writeEBML(t.data),t.size!==-1){let u=this.pos-n,b=this.pos;this.seek(s),this.writeEBMLVarInt(u,a),this.seek(b)}}else if(typeof t.data=="number"){let s=(r=t.size)!=null?r:pe(t.data);this.writeEBMLVarInt(s),h(this,pt,ge).call(this,t.data,s)}else typeof t.data=="string"?(this.writeEBMLVarInt(t.data.length),h(this,Yt,Oe).call(this,t.data)):t.data instanceof Uint8Array?(this.writeEBMLVarInt(t.data.byteLength,t.size),this.write(t.data)):t.data instanceof J?(this.writeEBMLVarInt(4),h(this,qt,_e).call(this,t.data.value)):t.data instanceof _&&(this.writeEBMLVarInt(8),h(this,Gt,We).call(this,t.data.value))}};z=new WeakMap,m=new WeakMap,Kt=new WeakSet,Re=function(t){e(this,m).setUint8(0,t),this.write(e(this,z).subarray(0,1))},qt=new WeakSet,_e=function(t){e(this,m).setFloat32(0,t,!1),this.write(e(this,z).subarray(0,4))},Gt=new WeakSet,We=function(t){e(this,m).setFloat64(0,t,!1),this.write(e(this,z))},pt=new WeakSet,ge=function(t,i=pe(t)){let r=0;switch(i){case 6:e(this,m).setUint8(r++,t/p(2,40)|0);case 5:e(this,m).setUint8(r++,t/p(2,32)|0);case 4:e(this,m).setUint8(r++,t>>24);case 3:e(this,m).setUint8(r++,t>>16);case 2:e(this,m).setUint8(r++,t>>8);case 1:e(this,m).setUint8(r++,t);break;default:throw new Error("Bad UINT size "+i)}this.write(e(this,z).subarray(0,r))},Yt=new WeakSet,Oe=function(t){this.write(new Uint8Array(t.split("").map(i=>i.charCodeAt(0))))};var gt,P,I,wt,we,Bt=class extends Ht{constructor(i){super();o(this,wt);o(this,gt,void 0);o(this,P,new ArrayBuffer(p(2,16)));o(this,I,new Uint8Array(e(this,P)));c(this,gt,i)}write(i){h(this,wt,we).call(this,this.pos+i.byteLength),e(this,I).set(i,this.pos),this.pos+=i.byteLength}finalize(){h(this,wt,we).call(this,this.pos),e(this,gt).buffer=e(this,P).slice(0,this.pos)}};gt=new WeakMap,P=new WeakMap,I=new WeakMap,wt=new WeakSet,we=function(i){let r=e(this,P).byteLength;for(;r<i;)r*=2;if(r===e(this,P).byteLength)return;let s=new ArrayBuffer(r),a=new Uint8Array(s);a.set(e(this,I),0),c(this,P,s),c(this,I,a)};var H,T,C,N,D=class extends Ht{constructor(i){super();this.target=i;o(this,H,!1);o(this,T,void 0);o(this,C,void 0);o(this,N,void 0)}write(i){if(!e(this,H))return;let r=this.pos;if(r<e(this,C)){if(r+i.byteLength<=e(this,C))return;i=i.subarray(e(this,C)-r),r=0}let s=r+i.byteLength-e(this,C),a=e(this,T).byteLength;for(;a<s;)a*=2;if(a!==e(this,T).byteLength){let n=new Uint8Array(a);n.set(e(this,T),0),c(this,T,n)}e(this,T).set(i,r-e(this,C)),c(this,N,Math.max(e(this,N),r+i.byteLength))}startTrackingWrites(){c(this,H,!0),c(this,T,new Uint8Array(p(2,10))),c(this,C,this.pos),c(this,N,this.pos)}getTrackedWrites(){if(!e(this,H))throw new Error("Can't get tracked writes since nothing was tracked.");let r={data:e(this,T).subarray(0,e(this,N)-e(this,C)),start:e(this,C),end:e(this,N)};return c(this,T,void 0),c(this,H,!1),r}};H=new WeakMap,T=new WeakMap,C=new WeakMap,N=new WeakMap;var v,yt,kt,mt=class extends D{constructor(i,r){super(i);o(this,v,[]);o(this,yt,0);o(this,kt,void 0);c(this,kt,r)}write(i){super.write(i),e(this,v).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}flush(){var s,a;if(e(this,v).length===0)return;let i=[],r=[...e(this,v)].sort((n,u)=>n.start-u.start);i.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let u=i[i.length-1],b=r[n];b.start<=u.start+u.size?u.size=Math.max(u.size,b.start+b.data.byteLength-u.start):i.push({start:b.start,size:b.data.byteLength})}for(let n of i){n.data=new Uint8Array(n.size);for(let u of e(this,v))n.start<=u.start&&u.start<n.start+n.size&&n.data.set(u.data,u.start-n.start);if(e(this,kt)&&n.start<e(this,yt))throw new Error("Internal error: Monotonicity violation.");(a=(s=this.target.options).onData)==null||a.call(s,n.data,n.start),c(this,yt,n.start+n.data.byteLength)}e(this,v).length=0}finalize(){}};v=new WeakMap,yt=new WeakMap,kt=new WeakMap;var bi=p(2,24),pi=2,k,w,xt,Tt,Ct,ye,Zt,He,Qt,Be,tt,Ot,bt=class extends D{constructor(i,r){var s,a;super(i);o(this,Ct);o(this,Zt);o(this,Qt);o(this,tt);o(this,k,void 0);o(this,w,[]);o(this,xt,0);o(this,Tt,void 0);if(c(this,k,(a=(s=i.options)==null?void 0:s.chunkSize)!=null?a:bi),c(this,Tt,r),!Number.isInteger(e(this,k))||e(this,k)<p(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(i){super.write(i),h(this,Ct,ye).call(this,i,this.pos),h(this,tt,Ot).call(this),this.pos+=i.byteLength}finalize(){h(this,tt,Ot).call(this,!0)}};k=new WeakMap,w=new WeakMap,xt=new WeakMap,Tt=new WeakMap,Ct=new WeakSet,ye=function(i,r){let s=e(this,w).findIndex(g=>g.start<=r&&r<g.start+e(this,k));s===-1&&(s=h(this,Qt,Be).call(this,r));let a=e(this,w)[s],n=r-a.start,u=i.subarray(0,Math.min(e(this,k)-n,i.byteLength));a.data.set(u,n);let b={start:n,end:n+u.byteLength};if(h(this,Zt,He).call(this,a,b),a.written[0].start===0&&a.written[0].end===e(this,k)&&(a.shouldFlush=!0),e(this,w).length>pi){for(let g=0;g<e(this,w).length-1;g++)e(this,w)[g].shouldFlush=!0;h(this,tt,Ot).call(this)}u.byteLength<i.byteLength&&h(this,Ct,ye).call(this,i.subarray(u.byteLength),r+u.byteLength)},Zt=new WeakSet,He=function(i,r){let s=0,a=i.written.length-1,n=-1;for(;s<=a;){let u=Math.floor(s+(a-s+1)/2);i.written[u].start<=r.start?(s=u+1,n=u):a=u-1}for(i.written.splice(n+1,0,r),(n===-1||i.written[n].end<r.start)&&n++;n<i.written.length-1&&i.written[n].end>=i.written[n+1].start;)i.written[n].end=Math.max(i.written[n].end,i.written[n+1].end),i.written.splice(n+1,1)},Qt=new WeakSet,Be=function(i){let s={start:Math.floor(i/e(this,k))*e(this,k),data:new Uint8Array(e(this,k)),written:[],shouldFlush:!1};return e(this,w).push(s),e(this,w).sort((a,n)=>a.start-n.start),e(this,w).indexOf(s)},tt=new WeakSet,Ot=function(i=!1){var r,s;for(let a=0;a<e(this,w).length;a++){let n=e(this,w)[a];if(!(!n.shouldFlush&&!i)){for(let u of n.written){if(e(this,Tt)&&n.start+u.start<e(this,xt))throw new Error("Internal error: Monotonicity violation.");(s=(r=this.target.options).onData)==null||s.call(r,n.data.subarray(u.start,u.end),n.start+u.start),c(this,xt,n.start+u.end)}e(this,w).splice(a--,1)}}};var $t=class extends bt{constructor(t,i){var r;super(new O({onData:(s,a)=>t.stream.write({type:"write",data:s,position:a}),chunked:!0,chunkSize:(r=t.options)==null?void 0:r.chunkSize}),i)}};var y=1,St=2,gi=1,wi=2,yi=17,ke=p(2,15),xe=p(2,12),$e="https://github.com/Vanilagy/webm-muxer",Ke=6,qe=5,ki=["strict","offset","permissive"],f,x,l,it,rt,A,B,$,F,S,K,q,U,G,Y,V,M,st,E,Z,at,nt,It,Ge,te,Ye,ee,Ze,ie,Qe,re,Xe,se,Le,ae,je,zt,Te,Dt,Ce,ne,Je,Q,At,R,et,Vt,Se,oe,Ie,he,ti,Pt,Ae,ot,Xt,de,ei,X,Ut,L,Et,ht,Lt,le,ii,Nt,Ue,dt,jt,Jt=class{constructor(t){o(this,It);o(this,te);o(this,ee);o(this,ie);o(this,re);o(this,se);o(this,ae);o(this,zt);o(this,Dt);o(this,ne);o(this,Q);o(this,R);o(this,Vt);o(this,oe);o(this,he);o(this,Pt);o(this,ot);o(this,de);o(this,X);o(this,L);o(this,ht);o(this,le);o(this,Nt);o(this,dt);o(this,f,void 0);o(this,x,void 0);o(this,l,void 0);o(this,it,void 0);o(this,rt,void 0);o(this,A,void 0);o(this,B,void 0);o(this,$,void 0);o(this,F,void 0);o(this,S,void 0);o(this,K,void 0);o(this,q,void 0);o(this,U,void 0);o(this,G,void 0);o(this,Y,0);o(this,V,[]);o(this,M,[]);o(this,st,[]);o(this,E,[]);o(this,Z,-1);o(this,at,void 0);o(this,nt,!1);var r;if(h(this,It,Ge).call(this,t),c(this,f,ve({type:"webm",firstTimestampBehavior:"strict"},t)),this.target=t.target,c(this,x,[]),e(this,f).video&&e(this,x).push(y),e(this,f).audio)for(let s of e(this,f).audio){if(e(this,x).includes(s.trackNumber))throw new Error(`Duplicated track number: ${s.trackNumber}`);e(this,x).push(s.trackNumber)}let i=!!e(this,f).streaming;if(t.target instanceof ct)c(this,l,new Bt(t.target));else if(t.target instanceof O)c(this,l,(r=t.target.options)!=null&&r.chunked?new bt(t.target,i):new mt(t.target,i));else if(t.target instanceof ft)c(this,l,new $t(t.target,i));else throw new Error(`Invalid target: ${t.target}`);h(this,te,Ye).call(this)}addVideoChunk(t,i,r){let s=new Uint8Array(t.byteLength);t.copyTo(s),this.addVideoChunkRaw(s,t.type,r!=null?r:t.timestamp,i)}addVideoChunkRaw(t,i,r,s){var n,u;if(h(this,dt,jt).call(this),!e(this,f).video)throw new Error("No video track declared.");(u=(n=e(this,st))[y])!=null||(n[y]=r),s&&h(this,oe,Ie).call(this,s);let a=h(this,ot,Xt).call(this,t,i,r,y);e(this,f).video.codec==="V_VP9"&&h(this,he,ti).call(this,a),h(this,Vt,Se).call(this,a)}addAudioChunk(t,i,r,s){let a=new Uint8Array(i.byteLength);i.copyTo(a),this.addAudioChunkRaw(t,a,i.type,s!=null?s:i.timestamp,r)}addAudioChunkRaw(t,i,r,s,a){var u,b;if(h(this,dt,jt).call(this),!e(this,f).audio)throw new Error("No audio track declared.");(b=(u=e(this,st))[t])!=null||(u[t]=s),a!=null&&a.decoderConfig&&(e(this,f).streaming?e(this,S)[t]=h(this,L,Et).call(this,a.decoderConfig.description):h(this,ht,Lt).call(this,e(this,S)[t],a.decoderConfig.description));let n=h(this,ot,Xt).call(this,i,r,s,t);h(this,Vt,Se).call(this,n)}addSubtitleChunk(t,i,r){if(h(this,dt,jt).call(this),!e(this,f).subtitles)throw new Error("No subtitle track declared.");i!=null&&i.decoderConfig&&(e(this,f).streaming?c(this,K,h(this,L,Et).call(this,i.decoderConfig.description)):h(this,ht,Lt).call(this,e(this,K),i.decoderConfig.description));let s=h(this,ot,Xt).call(this,t.body,"key",r!=null?r:t.timestamp,St,t.duration,t.additions);e(this,E)[St]=s.timestamp,e(this,M).push(s),h(this,Pt,Ae).call(this),h(this,Q,At).call(this)}finalize(){if(e(this,nt))throw new Error("Cannot finalize a muxer more than once.");let t=[];for(let i of e(this,x)){let r=e(this,V)[i];t.push(...r),r.length=0}t.sort((i,r)=>i.timestamp-r.timestamp);for(let i of t)h(this,X,Ut).call(this,i,!e(this,f).video||i.trackNumber===y);for(;e(this,M).length>0&&e(this,M)[0].timestamp<=e(this,Y);)h(this,X,Ut).call(this,e(this,M).shift(),!1);if(e(this,f).streaming||h(this,Nt,Ue).call(this),e(this,l).writeEBML(e(this,q)),!e(this,f).streaming){let i=e(this,l).pos,r=e(this,l).pos-e(this,R,et);e(this,l).seek(e(this,l).offsets.get(e(this,it))+4),e(this,l).writeEBMLVarInt(r,Ke),e(this,$).data=new _(e(this,Y)),e(this,l).seek(e(this,l).offsets.get(e(this,$))),e(this,l).writeEBML(e(this,$)),e(this,A).data[0].data[1].data=e(this,l).offsets.get(e(this,q))-e(this,R,et),e(this,A).data[1].data[1].data=e(this,l).offsets.get(e(this,rt))-e(this,R,et),e(this,A).data[2].data[1].data=e(this,l).offsets.get(e(this,B))-e(this,R,et),e(this,l).seek(e(this,l).offsets.get(e(this,A))),e(this,l).writeEBML(e(this,A)),e(this,l).seek(i)}h(this,Q,At).call(this),e(this,l).finalize(),c(this,nt,!0)}};f=new WeakMap,x=new WeakMap,l=new WeakMap,it=new WeakMap,rt=new WeakMap,A=new WeakMap,B=new WeakMap,$=new WeakMap,F=new WeakMap,S=new WeakMap,K=new WeakMap,q=new WeakMap,U=new WeakMap,G=new WeakMap,Y=new WeakMap,V=new WeakMap,M=new WeakMap,st=new WeakMap,E=new WeakMap,Z=new WeakMap,at=new WeakMap,nt=new WeakMap,It=new WeakSet,Ge=function(t){if(t.type&&t.type!=="webm"&&t.type!=="matroska")throw new Error(`Invalid type: ${t.type}`);if(t.firstTimestampBehavior&&!ki.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},te=new WeakSet,Ye=function(){e(this,l)instanceof D&&e(this,l).target.options.onHeader&&e(this,l).startTrackingWrites(),h(this,ee,Ze).call(this),e(this,f).streaming||h(this,se,Le).call(this),h(this,ae,je).call(this),h(this,ie,Qe).call(this),h(this,re,Xe).call(this),e(this,f).streaming||(h(this,zt,Te).call(this),h(this,Dt,Ce).call(this)),h(this,ne,Je).call(this),h(this,Q,At).call(this)},ee=new WeakSet,Ze=function(){var i;let t={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:(i=e(this,f).type)!=null?i:"webm"},{id:17031,data:2},{id:17029,data:2}]};e(this,l).writeEBML(t)},ie=new WeakSet,Qe=function(){c(this,S,[]);for(let t of e(this,x))e(this,S)[t]={id:236,size:4,data:new Uint8Array(xe)};c(this,K,{id:236,size:4,data:new Uint8Array(xe)})},re=new WeakSet,Xe=function(){c(this,F,{id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]})},se=new WeakSet,Le=function(){let t=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),r=new Uint8Array([22,84,174,107]),s={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:0}]}]};c(this,A,s)},ae=new WeakSet,je=function(){let t={id:17545,data:new _(0)};c(this,$,t);let i={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:$e},{id:22337,data:$e},e(this,f).streaming?null:t]};c(this,rt,i)},zt=new WeakSet,Te=function(){let t={id:374648427,data:[]};if(c(this,B,t),e(this,f).video&&(e(this,V)[y]=[],e(this,E)[y]=-1,t.data.push({id:174,data:[{id:215,data:y},{id:29637,data:y},{id:131,data:gi},{id:134,data:e(this,f).video.codec},e(this,S)[y],e(this,f).video.frameRate?{id:2352003,data:1e9/e(this,f).video.frameRate}:null,{id:224,data:[{id:176,data:e(this,f).video.width},{id:186,data:e(this,f).video.height},e(this,f).video.alpha?{id:21440,data:1}:null,e(this,F)]}]})),e(this,f).audio)for(let i of e(this,f).audio)e(this,V)[i.trackNumber]=[],e(this,E)[i.trackNumber]=-1,t.data.push({id:174,data:[{id:215,data:i.trackNumber},{id:29637,data:i.trackNumber},{id:131,data:wi},i.name?{id:21358,data:i.name}:null,{id:134,data:i.codec},e(this,S)[i.trackNumber],{id:225,data:[{id:181,data:new J(i.sampleRate)},{id:159,data:i.numberOfChannels},i.bitDepth?{id:25188,data:i.bitDepth}:null]}]});e(this,f).subtitles&&t.data.push({id:174,data:[{id:215,data:St},{id:29637,data:St},{id:131,data:yi},{id:134,data:e(this,f).subtitles.codec},e(this,K)]})},Dt=new WeakSet,Ce=function(){let t={id:408125543,size:e(this,f).streaming?-1:Ke,data:[e(this,f).streaming?null:e(this,A),e(this,rt),e(this,B)]};if(c(this,it,t),e(this,l).writeEBML(t),e(this,l)instanceof D&&e(this,l).target.options.onHeader){let{data:i,start:r}=e(this,l).getTrackedWrites();e(this,l).target.options.onHeader(i,r)}},ne=new WeakSet,Je=function(){c(this,q,{id:475249515,data:[]})},Q=new WeakSet,At=function(){e(this,l)instanceof mt&&e(this,l).flush()},R=new WeakSet,et=function(){return e(this,l).dataOffsets.get(e(this,it))},Vt=new WeakSet,Se=function(t){let i=e(this,E)[t.trackNumber];if(e(this,E)[t.trackNumber]=t.timestamp,i!==e(this,Z)){e(this,V)[t.trackNumber].push(t);return}let r=1/0;for(let a of e(this,x)){let n=e(this,E)[a];if(n===e(this,Z)){e(this,V)[t.trackNumber].push(t);return}n<r&&(r=n)}let s=[];for(let a of e(this,x)){let n=e(this,V)[a],u=0;for(;u<n.length&&!(n[u].timestamp>r);u++)s.push(n[u]);n.splice(0,u)}s.push(t),s.sort((a,n)=>a.timestamp-n.timestamp);for(let a of s)h(this,X,Ut).call(this,a,!e(this,f).video||a.trackNumber===y);c(this,Z,r),h(this,Pt,Ae).call(this),h(this,Q,At).call(this)},oe=new WeakSet,Ie=function(t){if(!!t.decoderConfig){if(t.decoderConfig.colorSpace){let i=t.decoderConfig.colorSpace;if(c(this,at,i),e(this,F).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[i.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[i.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[i.primaries]},{id:21945,data:[1,2][Number(i.fullRange)]}],!e(this,f).streaming){let r=e(this,l).pos;e(this,l).seek(e(this,l).offsets.get(e(this,F))),e(this,l).writeEBML(e(this,F)),e(this,l).seek(r)}}t.decoderConfig.description&&(e(this,f).streaming?e(this,S)[y]=h(this,L,Et).call(this,t.decoderConfig.description):h(this,ht,Lt).call(this,e(this,S)[y],t.decoderConfig.description))}},he=new WeakSet,ti=function(t){if(t.type!=="key"||!e(this,at))return;let i=0;if(W(t.data,0,2)!==2)return;i+=2;let r=(W(t.data,i+1,i+2)<<1)+W(t.data,i+0,i+1);i+=2,r===3&&i++;let s=W(t.data,i+0,i+1);if(i++,s)return;let a=W(t.data,i+0,i+1);if(i++,a!==0)return;i+=2;let n=W(t.data,i+0,i+24);if(i+=24,n!==4817730)return;r>=2&&i++;let u={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e(this,at).matrix];Me(t.data,i+0,i+3,u)},Pt=new WeakSet,Ae=function(){let t=e(this,M);for(;t.length>0&&t[0].timestamp<=e(this,Z);)h(this,X,Ut).call(this,t.shift(),!e(this,f).video&&!e(this,f).audio)},ot=new WeakSet,Xt=function(t,i,r,s,a,n){let u=h(this,de,ei).call(this,r,s);return{data:t,additions:n,type:i,timestamp:u,duration:a,trackNumber:s}},de=new WeakSet,ei=function(t,i){let r=e(this,E)[i];if(!e(this,f).subtitles||i!==St){let s=e(this,st)[i];if(e(this,f).firstTimestampBehavior==="strict"&&r===-1&&t!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${t}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);e(this,f).firstTimestampBehavior==="offset"&&(t-=s)}if(t<r)throw new Error(`Timestamps must be monotonically increasing (went from ${r} to ${t}).`);if(t<0)throw new Error(`Timestamps must be non-negative (received ${t}).`);return t},X=new WeakSet,Ut=function(t,i){e(this,f).streaming&&!e(this,B)&&(h(this,zt,Te).call(this),h(this,Dt,Ce).call(this));let r=Math.floor(t.timestamp/1e3),s=i&&t.type==="key"&&r-e(this,G)>=1e3;(!e(this,U)||s)&&h(this,le,ii).call(this,r);let a=r-e(this,G);if(a<0)return;if(a>=ke)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${ke} milliseconds. In order to produce a correct WebM file, you must pass in a key frame at least every ${ke} milliseconds.`);let u=new Uint8Array(4),b=new DataView(u.buffer);if(b.setUint8(0,128|t.trackNumber),b.setInt16(1,a,!1),t.duration===void 0&&!t.additions){b.setUint8(3,Number(t.type==="key")<<7);let g={id:163,data:[u,t.data]};e(this,l).writeEBML(g)}else{let g=Math.floor(t.duration/1e3),ut={id:160,data:[{id:161,data:[u,t.data]},t.duration!==void 0?{id:155,data:g}:null,t.additions?{id:30113,data:t.additions}:null]};e(this,l).writeEBML(ut)}c(this,Y,Math.max(e(this,Y),r))},L=new WeakSet,Et=function(t){return{id:25506,size:4,data:new Uint8Array(t)}},ht=new WeakSet,Lt=function(t,i){let r=e(this,l).pos;e(this,l).seek(e(this,l).offsets.get(t));let s=2+4+i.byteLength,a=xe-s;if(a<0){let n=i.byteLength+a;i instanceof ArrayBuffer?i=i.slice(0,n):i=i.buffer.slice(0,n),a=0}t=[h(this,L,Et).call(this,i),{id:236,size:4,data:new Uint8Array(a)}],e(this,l).writeEBML(t),e(this,l).seek(r)},le=new WeakSet,ii=function(t){e(this,U)&&!e(this,f).streaming&&h(this,Nt,Ue).call(this),e(this,l)instanceof D&&e(this,l).target.options.onCluster&&e(this,l).startTrackingWrites(),c(this,U,{id:524531317,size:e(this,f).streaming?-1:qe,data:[{id:231,data:t}]}),e(this,l).writeEBML(e(this,U)),c(this,G,t);let i=e(this,l).offsets.get(e(this,U))-e(this,R,et);e(this,q).data.push({id:187,data:[{id:179,data:t},...e(this,x).map(r=>({id:183,data:[{id:247,data:r},{id:241,data:i}]}))]})},Nt=new WeakSet,Ue=function(){let t=e(this,l).pos-e(this,l).dataOffsets.get(e(this,U)),i=e(this,l).pos;if(e(this,l).seek(e(this,l).offsets.get(e(this,U))+4),e(this,l).writeEBMLVarInt(t,qe),e(this,l).seek(i),e(this,l)instanceof D&&e(this,l).target.options.onCluster){let{data:r,start:s}=e(this,l).getTrackedWrites();e(this,l).target.options.onCluster(r,s,e(this,G))}},dt=new WeakSet,jt=function(){if(e(this,nt))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var vt=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,xi=/^WEBVTT.*?\n{2}/,Ti=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,ri=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Ee=new TextEncoder,j,Ft,Mt,Rt,_t,lt,ue,fe,si,ce=class{constructor(t){o(this,lt);o(this,fe);o(this,j,void 0);o(this,Ft,void 0);o(this,Mt,!1);o(this,Rt,void 0);o(this,_t,!1);c(this,j,t)}configure(t){if(t.codec!=="webvtt")throw new Error("Codec must be 'webvtt'.");c(this,Ft,t)}encode(t){var r;if(!e(this,Ft))throw new Error("Encoder not configured.");t=t.replace(`\r
`,`
`).replace("\r",`
`),vt.lastIndex=0;let i;if(!e(this,Mt)){if(!xi.test(t)){let a=new Error("WebVTT preamble incorrect.");throw e(this,j).error(a),a}i=vt.exec(t);let s=t.slice(0,(r=i==null?void 0:i.index)!=null?r:t.length).trimEnd();if(!s){let a=new Error("No WebVTT preamble provided.");throw e(this,j).error(a),a}c(this,Rt,Ee.encode(s)),c(this,Mt,!0),i&&(t=t.slice(i.index),vt.lastIndex=0)}for(;i=vt.exec(t);){let s=t.slice(0,i.index),a=i[1]||"",n=i.index+i[0].length,u=t.indexOf(`
`,n)+1,b=t.slice(n,u).trim(),g=t.indexOf(`

`,n);g===-1&&(g=t.length);let ut=h(this,lt,ue).call(this,i[2]),ai=h(this,lt,ue).call(this,i[3])-ut,me=t.slice(u,g),ze=`${b}
${a}
${s}`;ri.lastIndex=0,me=me.replace(ri,oi=>{let hi=h(this,lt,ue).call(this,oi.slice(1,-1))-ut;return`<${h(this,fe,si).call(this,hi)}>`}),t=t.slice(g).trimStart(),vt.lastIndex=0;let ni={body:Ee.encode(me),additions:ze.trim()===""?void 0:Ee.encode(ze),timestamp:ut*1e3,duration:ai*1e3},De={};e(this,_t)||(De.decoderConfig={description:e(this,Rt)},c(this,_t,!0)),e(this,j).output(ni,De)}}};j=new WeakMap,Ft=new WeakMap,Mt=new WeakMap,Rt=new WeakMap,_t=new WeakMap,lt=new WeakSet,ue=function(t){let i=Ti.exec(t);if(!i)throw new Error("Expected match.");return 60*60*1e3*Number(i[1]||"0")+60*1e3*Number(i[2])+1e3*Number(i[3])+Number(i[4])},fe=new WeakSet,si=function(t){let i=Math.floor(t/36e5),r=Math.floor(t%(60*60*1e3)/(60*1e3)),s=Math.floor(t%(60*1e3)/1e3),a=t%1e3;return i.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+"."+a.toString().padStart(3,"0")};return mi(Ci);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, WebMMuxer)
